
name: Publish to PyPI
on:
  workflow_dispatch:

permissions:            # 2
  attestations: write
  contents: write
  id-token: write

jobs:
  build:                # 3
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.create_tag.outputs.tag }}
    steps:      
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install bump-my-version
        run: pip install bump-my-version

      - name: Bump version (minor)
        run: bump-my-version bump minor

      - name: Commit version bump
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add pyproject.toml oh_my_ralph/__init__.py
          git commit -m "Bump version [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create and push tag
        id: create_tag
        run: |
          # Get version from pyproject.toml
          version=$(sed -n 's/^version = "\(.*\)"/\1/p' pyproject.toml | head -n 1)
          tag="v${version}"
          echo "Creating tag ${tag}"
          # Ensure we can push with the token
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git tag -a "${tag}" -m "Release ${tag}"
          git push origin "${tag}"
          echo "tag=${tag}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: hynek/build-and-inspect-python-package@v2
        with:
          attest-build-provenance-github: 'true'

  publish-pypi:         # 5
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: Packages
          path: dist
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build.outputs.tag_name }}
          release_name: Release ${{ needs.build.outputs.tag_name }}
          body: Release ${{ needs.build.outputs.tag_name }}