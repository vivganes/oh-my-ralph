
name: Publish to PyPI
on:
  workflow_dispatch:

permissions:            # 2
  attestations: write
  contents: write
  id-token: write

jobs:
  build:                # 3
    runs-on: ubuntu-latest
    steps:
      - name: Install bump-my-version
        run: pip install bump-my-version

      - name: Bump version (patch)
        run: bump-my-version bump patch --config-file pyproject.toml oh_my_ralph/__init__.py

      - name: Commit version bump
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add pyproject.toml oh_my_ralph/__init__.py
          git commit -m "Bump version [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: hynek/build-and-inspect-python-package@v2
        with:
          attest-build-provenance-github: 'true'

  publish-pypi:         # 5
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: Packages
          path: dist
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: Release ${{ github.ref }}